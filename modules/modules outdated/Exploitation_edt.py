import emploidutemps as e

JOURS = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"]
MOIS = ['0' + str(i) for i in range(1, 10)]
for i in range(10, 13):
    MOIS.append(str(i))

def load_edt(fichier):
    with open(fichier) as file:
        for (i, horaire) in enumerate(file): #Lundi 22 01 2021 8 00 motif 15
            H = horaire.split()
            if i == 0:
                edt = e.Edt(H[0], int(H[1]), int(H[2]), int(H[3]))
                heure_journee = int(H[4]) # Heure du début de la journée
                minute_journee = int(H[5]) # Minute du début de la journée
                horaire_debut_boucle_while = e.Heure(heure_journee, minute_journee)  #Heure du début de la journée
            jour = H[0] #pas de la classe Jour
            heure_rdv = int(H[4])
            minute_rdv = int(H[5])
            heure_debut = e.Heure(heure_rdv, minute_rdv) # Heure du rdv
            motif = e.Motif(H[6], int(H[-1]))
            for j in range(7):
                if jour == JOURS[j]:
                    while horaire_debut_boucle_while < heure_debut: #hor_deb_bou_whi < heure_debut
                        if minute_journee == 45:
                            heure_journee += 1
                            minute_journee = 0
                            horaire_debut_boucle_while = e.Heure(heure_journee, minute_journee)
                        else:
                            minute_journee += 15
                            horaire_debut_boucle_while = e.Heure(heure_journee, minute_journee)
                    edt.modifier(j, heure_debut, motif) #plus de la classe Heure, seulement la représentation, pour pouvoir y accéder après
    return edt


def edt_creneaux_libres(edt, heure_debut, heure_fin):
    edt_creneaux_vides = e.Edt(edt.lundi, edt.nb_lundi, edt.mois_lundi, edt.annee)
    Liste_heure = []
    for jour in range(7):
        for heure in range(heure_debut.heure, heure_fin.heure):
            for minute in range(0, 46, 15):
                heure_rdv = e.Heure(heure, minute)
                try:
                    motif = edt.un_jour_de_edt(jour).un_horaire(heure_rdv)
                    duree_rdv = motif.duree
                    duree_boucle = duree_rdv // 15
                    Liste_heure = []
                    heure_i = heure_rdv
                    for i in range(duree_boucle-1):
                        if heure_i.minute == 45:
                            heure_i.heure += 1
                            heure_i.minute = 0
                            heure_i = e.Heure(heure_i.heure, heure_i.minute)
                        else:
                            heure_i.minute += 15
                            heure_i = e.Heure(heure_i.heure, heure_i.minute)
                        Liste_heure.append(heure_i.repr)
                except KeyError:
                    duree_plus_15_min = False
                    for i in range(len(Liste_heure)):
                        if heure_rdv.repr == Liste_heure[i]:
                            duree_plus_15_min = True
                    if duree_plus_15_min == False:
                        edt_creneaux_vides.modifier(jour, heure_rdv, '')
        try:
            edt.un_jour_de_edt(jour).un_horaire(heure_fin)
        except KeyError:
            edt_creneaux_vides.modifier(jour, heure_fin, '')
    return edt_creneaux_vides

"""
def ajouter_rdv_edt(edt, nom_jour, nb_jour, mois, annee, heure_rdv, motif): #motif de la classe Motif 
    edt_creneaux_vides = edt.edt_creneaux_libres
    Liste_heure = []
    duree_rdv = motif.duree
    duree_boucle = duree_rdv // 15
    heure_i = heure_rdv
    for i in range(duree_boucle-1):
        if heure_i.minute == 45:
            heure_i.heure += 1
            heure_i.minute = 0
            heure_i = e.Heure(heure_i.heure, heure_i.minute)
        else:
            heure_i.minute += 15
            heure_i = e.Heure(heure_i.heure, heure_i.minute)
        Liste_heure.append(heure_i.repr)
    for j in range(7):
        if nom_jour == JOURS[j]:
            try:
                edt_creneaux_vides.un_horaire(heure_rdv)
            except KeyError:
                edt.modifier(j, heure_rdv, motif)
                del edt_creneaux_vides.un_jour_de_edt(j).un_horaire(heure_rdv) #cannot delete function call apparemment
                for heure_i in Liste_heure:
                    del edt_creneaux_vides.un_jour_de_edt(j).un_horaire(heure_i)
    return (edt, edt_creneaux_vides)
"""

def ajouter_rdv(fichier, nom_jour, nb_jour, mois, annee, heure_rdv, motif_rdv):
    with open(fichier, 'r') as file:
        contents = file.readlines()
        for (r, rdv) in enumerate(contents):
            H = rdv.split()
            if nom_jour == H[0]:
                heure_avant = e.Heure(8, 0)
                heure = e.Heure(int(H[4]), int(H[5]))
                index = r
                if heure_rdv < heure:
                    duree_rdv = motif_rdv.duree
                    duree_boucle_rdv = duree_rdv // 15
                    heure_i = heure_rdv
                    for i in range(duree_boucle_rdv - 1):
                        if heure_i.minute == 45:
                            heure_i.heure += 1
                            heure_i.minute = 0
                            heure_i = e.Heure(heure_i.heure, heure_i.minute)
                        else:
                            heure_i.minute += 15
                            heure_i = e.Heure(heure_i.heure, heure_i.minute)
                        if heure.repr == heure_i.repr:
                            return "Le rendez-vous empiète sur un autre rendez-vous."
                    break
                motif = e.Motif(H[6], int(H[7]))
                duree_rdv = motif.duree
                duree_boucle = duree_rdv // 15
                heure_i = heure
                if heure < heure_rdv:
                    heure_avant = heure
                    index = r
                for i in range(duree_boucle - 1):
                    if heure_i.minute == 45:
                            heure_i.heure += 1
                            heure_i.minute = 0
                            heure_i = e.Heure(heure_i.heure, heure_i.minute)
                    else:
                        heure_i.minute += 15
                        heure_i = e.Heure(heure_i.heure, heure_i.minute)
                    if heure_i < heure_rdv:
                        heure_avant = heure_i
                        index = r
                    if heure_i.repr == heure_rdv.repr:
                        return "Ce créneau est déjà occupé"
                if heure.repr == heure_rdv.repr:
                    return "Ce créneau est déjà occupé"
                if r == len(contents) - 1:
                    index = len(contents)
            elif JOURS.index(nom_jour) < JOURS.index(H[0]): #S'il n'y a pas de rdv un jour de la semaine
                index = r
                duree_rdv = motif_rdv.duree
                break
            elif r == len(contents) - 1 and JOURS.index(nom_jour) > JOURS.index(H[0]):
                index = len(contents)
                duree_rdv = motif_rdv.duree


    contents.insert(index, nom_jour + ' ' + str(nb_jour) + ' ' + MOIS[mois-1] + ' ' + str(annee) + ' ' + heure_rdv.repr[:2] + ' ' + heure_rdv.repr[3:] + ' ' + motif_rdv.motif + ' ' + str(duree_rdv) + '\n')

    with open(fichier, 'w') as file:
        contents = "".join(contents)
        file.write(contents)

    return file
            

def edt_to_fichier(edt):
    fichier = open ("Emploi_du_temps.txt", "a")
    annee = edt.annee
    for j in range(7):
        nb_jour = edt.un_jour_de_edt(j).nb_jour
        mois = edt.un_jour_de_edt(j).mois
        for horaire in edt.un_jour_de_edt(j).jour.keys:
            motif = edt.un_jour_de_edt.un_horaire(horaire).motif
            duree_rdv = str(edt.un_jour_de_edt.un_horaire(horaire).duree)
            fichier.write(JOURS[j] + ' ' + str(nb_jour) + ' ' + str(mois) + ' ' + str(annee) + ' ' + horaire.repr[:2] + ' ' + horaire.repr[3:] + motif + ' ' + str(duree_rdv) + '\n')
    fichier.close()


def supprimer_rdv(fichier, nom_jour, nb_jour, mois, annee, heure_rdv):
    with open(fichier, 'r+') as file:
        contents = file.readlines()
        for rdv in contents:
            H = rdv.split()
            
            if rdv != nom_jour + ' ' + str(nb_jour) + ' ' + MOIS[mois-1] + ' ' + str(annee) + ' ' + heure_rdv.repr[:2] + ' ' + heure_rdv.repr[3:] + ' ' + motif_rdv.motif + ' ' + str(motif_rdv.duree) + '\n':
                file.write(rdv)

            
if __name__ == '__main__':

    edt = load_edt('Test_edt.txt')
    print(edt)
    edt_creneaux_vides = edt.edt_creneaux_libres
    print(edt_creneaux_vides)
    file = supprimer_rdv('Test_edt.txt', 'Lundi', 22, 1, 2021, e.Heure(10, 45), e.Motif('gynecologue', ))
